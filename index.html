<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USA Auto Manufacturing Map - 米国自動車製造拠点マッピング</title>
    <meta name="description" content="米国内の自動車関連製造拠点を可視化・管理するインタラクティブなマップアプリケーション。メーカー種別、工程タイプ別のフィルタリングが可能です。">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        },
                        japanese: '#ef4444',
                        us: '#3b82f6',
                        european: '#10b981',
                        ev: '#f59e0b',
                        battery: '#8b5cf6'
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        h1, h2, h3 {
            font-family: 'Outfit', sans-serif;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 1rem;
            z-index: 10;
        }
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #0ea5e9;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }
        /* Custom Tooltip Styles */
        .leaflet-tooltip {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 5px 10px -5px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            padding: 12px;
            min-width: 200px;
            max-width: 280px;
        }
        .leaflet-tooltip-left::before,
        .leaflet-tooltip-right::before {
            border-left-color: rgba(255, 255, 255, 0.95);
        }
        .leaflet-tooltip-top::before,
        .leaflet-tooltip-bottom::before {
            border-top-color: rgba(255, 255, 255, 0.95);
        }
        .tooltip-content {
            pointer-events: none;
        }
        .tooltip-content h4 {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        .tooltip-content .location {
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .tooltip-content .detail-row {
            font-size: 11px;
            color: #475569;
            margin: 3px 0;
        }
        .tooltip-content .detail-row span:first-child {
            color: #94a3b8;
        }
        .tooltip-content .details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
            font-size: 10px;
            color: #64748b;
            font-style: italic;
            line-height: 1.4;
        }
        .tooltip-content .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 8px;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .tab-active {
            border-bottom: 2px solid #0ea5e9;
            color: #0ea5e9;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-slate-900 antialiased overflow-x-hidden">
    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-panel border-b px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <div class="bg-primary-600 p-2 rounded-lg text-white">
                <i data-lucide="map"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-slate-800">USA Auto Hub <span class="text-primary-600">Mapper</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-sm font-medium text-slate-500 hidden sm:inline-block">2025 Market Intelligence</span>
            <button id="export-btn" class="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-slate-700 transition-all shadow-md active:scale-95">
                <i data-lucide="download" class="w-4 h-4"></i>
                CSVエクスポート
            </button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-sm font-medium text-slate-500">総拠点数</p>
                <div class="flex items-end gap-2 mt-1">
                    <h3 id="stat-total" class="text-3xl font-bold">0</h3>
                    <span class="text-slate-400 mb-1 text-sm">locations</span>
                </div>
            </div>
            <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-sm font-medium text-slate-500">日系メーカー</p>
                <div class="flex items-end gap-2 mt-1 text-japanese">
                    <h3 id="stat-japanese" class="text-3xl font-bold">0</h3>
                    <i data-lucide="trending-up" class="w-4 h-4 mb-2"></i>
                </div>
            </div>
            <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-sm font-medium text-slate-500">EV/バッテリー系</p>
                <div class="flex items-end gap-2 mt-1 text-ev">
                    <h3 id="stat-ev" class="text-3xl font-bold">0</h3>
                    <span class="text-slate-400 mb-1 text-sm">sites</span>
                </div>
            </div>
            <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-sm font-medium text-slate-500">主要生産州</p>
                <div class="flex items-end gap-2 mt-1 text-primary-600">
                    <h3 id="stat-state" class="text-xl font-bold pt-2">KY, MI, TN</h3>
                </div>
            </div>
        </div>

        <!-- Controls & Tabs -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
            <div class="flex items-center bg-slate-200/50 p-1 rounded-xl w-full md:w-auto">
                <button id="tab-map" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-2 rounded-lg text-sm font-semibold bg-white shadow-sm text-primary-700 transition-all">
                    <i data-lucide="map-pin" class="w-4 h-4"></i>
                    マップビュー
                </button>
                <button id="tab-table" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-2 rounded-lg text-sm font-semibold text-slate-600 hover:bg-white/50 transition-all">
                    <i data-lucide="table" class="w-4 h-4"></i>
                    テーブルビュー
                </button>
            </div>
            
            <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                <div class="relative flex-1 md:flex-none">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input id="search-input" type="text" placeholder="メーカー・州・都市で検索..." class="pl-10 pr-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white w-full sm:w-64">
                </div>
                <select id="filter-category" class="px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white text-sm">
                    <option value="all">全カテゴリー</option>
                    <option value="japanese">日系メーカー</option>
                    <option value="us">米国メーカー</option>
                    <option value="european">欧州メーカー</option>
                    <option value="ev">EVメーカー</option>
                    <option value="battery">バッテリーメーカー</option>
                </select>
                <select id="filter-process" class="px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white text-sm">
                    <option value="all">全工程</option>
                    <option value="assembly">組立</option>
                    <option value="battery-mfg">バッテリー製造</option>
                    <option value="components">部品製造</option>
                    <option value="powertrain">パワートレイン</option>
                </select>
            </div>
        </div>

        <!-- Content Area -->
        <div id="view-map" class="fade-in">
            <div class="glass-panel p-2 rounded-2xl shadow-xl border border-slate-200 relative overflow-hidden">
                <div id="map"></div>
                <!-- Legend -->
                <div class="absolute bottom-6 right-6 z-[1000] glass-panel p-3 rounded-lg text-xs font-semibold flex flex-col gap-2 shadow-lg border border-slate-200">
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-japanese"></span>日系</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-us"></span>米国</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-european"></span>欧州</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-ev"></span>EV</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-battery"></span>電池</div>
                </div>
            </div>
        </div>

        <div id="view-table" class="fade-in hidden">
            <div class="glass-panel rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-6 py-4 text-sm font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100" onclick="sortTable('name')">メーカー/拠点 <i data-lucide="list-filter" class="inline w-3 h-3"></i></th>
                                <th class="px-6 py-4 text-sm font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100" onclick="sortTable('location')">所在地 <i data-lucide="list-filter" class="inline w-3 h-3"></i></th>
                                <th class="px-6 py-4 text-sm font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100" onclick="sortTable('product')">生産品目</th>
                                <th class="px-6 py-4 text-sm font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100" onclick="sortTable('capacity')">生産能力</th>
                                <th class="px-6 py-4 text-sm font-bold text-slate-500 uppercase tracking-wider">カテゴリー</th>
                                <th class="px-6 py-4 text-sm font-bold text-slate-500 uppercase tracking-wider">工程</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-slate-900 text-slate-400 py-12 px-6 mt-12">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-8">
            <div>
                <h2 class="text-white text-xl font-bold mb-2">USA Auto Manufacturing Intelligence</h2>
                <p class="text-sm">自動車製造拠点の可視化とデータ分析プラットフォーム</p>
            </div>
            <div class="text-right text-xs">
                &copy; 2025 Auto Map System. All Rights Reserved.
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Main App Logic -->
    <script>
        // Data Initialization
        const factoryData = [
            { id: 1, name: "Toyota Motor Manufacturing Kentucky", city: "Georgetown", state: "KY", lat: 38.2091, lng: -84.5531, product: "Camry, RAV4 Hybrid", capacity: "550,000台/年", area: "1,300エーカー", process: "assembly", category: "japanese", details: "トヨタ米国内最大の生産拠点。プレスから組立まで一貫生産。" },
            { id: 2, name: "Honda Development & Mfg of America", city: "Marysville", state: "OH", lat: 40.2364, lng: -83.3672, product: "Accord, CR-V", capacity: "440,000台/年", area: "400万平方フィート", process: "assembly", category: "japanese", details: "北米ホンダの主要生産拠点。EV生産への移行準備中。" },
            { id: 3, name: "Nissan North America Smyrna Plant", city: "S Smyrna", state: "TN", lat: 35.9818, lng: -86.5186, product: "Leaf, Rogue, Pathfinder", capacity: "640,000台/年", area: "600万平方フィート", process: "assembly", category: "japanese", details: "量産EV「リーフ」をいち早く北米で生産開始した拠点。" },
            { id: 4, name: "DENSO Manufacturing Tennessee", city: "Maryville", state: "TN", lat: 35.7564, lng: -83.9705, product: "スターター, オルタネーター", capacity: "数百万個/年", area: "150万平方フィート", process: "components", category: "japanese", details: "トヨタ等のTier1サプライヤー。電子製品、車両制御システムを生産。" },
            { id: 5, name: "GM Factory ZERO", city: "Detroit", state: "MI", lat: 42.3413, lng: -83.0560, product: "Hummer EV, Silverado EV", capacity: "200,000台/年", area: "410万平方フィート", process: "assembly", category: "us", details: "GMのEV専用生産拠点。旧デトロイト・ハムトラムク工場を刷新。" },
            { id: 6, name: "Ford Rouge Electric Vehicle Center", city: "Dearborn", state: "MI", lat: 42.3023, lng: -83.1557, product: "F-150 Lightning", capacity: "150,000台/年", area: "歴史的拠点内", process: "assembly", category: "us", details: "フォードの主力EVピックアップ生産の象徴的な拠点。" },
            { id: 7, name: "Tesla Giga Texas", city: "Austin", state: "TX", lat: 30.2305, lng: -97.6171, product: "Model Y, Cybertruck", capacity: "500,000台/年", area: "2,500エーカー", process: "assembly", category: "ev", details: "テスラの最新本社兼生産拠点。ダイキャスト「ギガプレス」を導入。" },
            { id: 8, name: "Tesla Factory Fremont", city: "Fremont", state: "CA", lat: 37.4924, lng: -121.9442, product: "Model 3, S, X, Y", capacity: "600,000台/年", area: "370エーカー", process: "assembly", category: "ev", details: "旧NUMMI(GM/Toyota合弁)跡地。テスラ初の量産拠点。" },
            { id: 9, name: "Rivian Normal Plant", city: "Normal", state: "IL", lat: 40.5135, lng: -89.0494, product: "R1T, R1S, EDV", capacity: "150,000台/年", area: "330万平方フィート", process: "assembly", category: "ev", details: "新興EVメーカーの拠点。三菱自動車の旧工場を活用。" },
            { id: 10, name: "BMW Plant Spartanburg", city: "Greer", state: "SC", lat: 34.8924, lng: -82.2189, product: "X3, X4, X5, X6, X7", capacity: "450,000台/年", area: "1,150エーカー", process: "assembly", category: "european", details: "BMWグループ最大の世界生産拠点。輸出比率が高い。" },
            { id: 11, name: "Volvo Cars Ridgeville", city: "Ridgeville", state: "SC", lat: 33.1542, lng: -80.3164, product: "S60, EX90", capacity: "150,000台/年", area: "1,600エーカー", process: "assembly", category: "european", details: "ボルボ初のアメリカ工場。完全EV化へ向けて投資中。" },
            { id: 12, name: "LG Energy Solution Michigan", city: "Holland", state: "MI", lat: 42.7592, lng: -86.1044, product: "Li-ion Battery Cell", capacity: "20GWh/年", area: "100万平方フィート", process: "battery-mfg", category: "battery", details: "大手バッテリーメーカー。GM等のEV向けにセルを供給。" },
            { id: 13, name: "Panasonic Energy Kansas", city: "De Soto", state: "KS", lat: 38.9722, lng: -94.9754, product: "4680/2170 Cell", capacity: "30GWh/年", area: "建設中", process: "battery-mfg", category: "battery", details: "テスラ向け等のバッテリー生産拠点を新設中。" },
            { id: 14, name: "BlueOval SK Battery Park", city: "Glendale", state: "KY", lat: 37.6015, lng: -85.9189, product: "EV Battery", capacity: "86GWh/年", area: "新規開発", process: "battery-mfg", category: "battery", details: "FordとSK Onの合弁。全米最大級の電池生産地帯を形成。" },
            { id: 15, name: "Hyundai Motor Group Metaplant America", city: "Ellabell", state: "GA", lat: 32.1265, lng: -81.4429, product: "IONIQ 5, EV9", capacity: "300,000台/年", area: "2,900エーカー", process: "assembly", category: "ev", details: "現代自のEV専用大規模工場。2025年稼働予定。" }
        ];

        let map;
        let markers = [];
        let currentSort = { key: 'name', asc: true };

        // Initialize App
        function init() {
            lucide.createIcons();
            initMap();
            renderTable(factoryData);
            updateStats(factoryData);
            setupEventListeners();
        }

        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            renderMarkers(factoryData);
        }

        function getCategoryColor(category) {
            switch(category) {
                case 'japanese': return '#ef4444';
                case 'us': return '#3b82f6';
                case 'european': return '#10b981';
                case 'ev': return '#f59e0b';
                case 'battery': return '#8b5cf6';
                default: return '#64748b';
            }
        }

        function renderMarkers(data) {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            data.forEach(item => {
                const color = getCategoryColor(item.category);
                const badgeClass = getCategoryBadgeClass(item.category);

                // Custom Icon with larger hover area
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });

                // Tooltip content (shows on hover)
                const tooltipContent = `
                    <div class="tooltip-content">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                            <h4>${item.name}</h4>
                        </div>
                        <p class="location">${item.city}, ${item.state}</p>
                        <div class="detail-row"><span>生産:</span> ${item.product}</div>
                        <div class="detail-row"><span>能力:</span> ${item.capacity}</div>
                        <div class="details">${item.details}</div>
                        <span class="category-badge ${badgeClass}">${item.category}</span>
                    </div>
                `;

                // Popup content (shows on click)
                const popupContent = `
                    <div class="p-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                            <h4 class="font-bold text-base leading-tight">${item.name}</h4>
                        </div>
                        <p class="text-xs text-slate-500 mb-2 font-semibold">${item.city}, ${item.state}</p>
                        <div class="space-y-1 text-xs">
                            <div><span class="text-slate-400">生産:</span> ${item.product}</div>
                            <div><span class="text-slate-400">能力:</span> ${item.capacity}</div>
                            <div class="mt-2 py-1 border-t text-slate-600 italic">${item.details}</div>
                        </div>
                    </div>
                `;

                const marker = L.marker([item.lat, item.lng], { icon: customIcon })
                    .bindTooltip(tooltipContent, {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -10],
                        opacity: 1,
                        className: 'custom-tooltip'
                    })
                    .bindPopup(popupContent);

                marker.addTo(map);
                markers.push(marker);
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-100 hover:bg-slate-50 transition-colors group cursor-pointer';
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${item.name}</div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-tighter">${item.id.toString().padStart(4, '0')} SKU REF</div>
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-600">${item.city}, ${item.state}</td>
                    <td class="px-6 py-4 text-sm text-slate-600">${item.product}</td>
                    <td class="px-6 py-4 text-sm font-mono text-slate-500">${item.capacity}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${getCategoryBadgeClass(item.category)}">
                            ${item.category}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="flex items-center gap-1 text-xs text-slate-500">
                            <i data-lucide="settings" class="w-3 h-3"></i>
                            ${item.process}
                        </span>
                    </td>
                `;
                tr.addEventListener('click', () => {
                    document.getElementById('tab-map').click();
                    map.setView([item.lat, item.lng], 10);
                    // Find and open popup
                    markers.find(m => m.getLatLng().lat === item.lat && m.getLatLng().lng === item.lng).openPopup();
                });
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function getCategoryBadgeClass(category) {
            switch(category) {
                case 'japanese': return 'bg-japanese/10 text-japanese';
                case 'us': return 'bg-us/10 text-us';
                case 'european': return 'bg-european/10 text-european';
                case 'ev': return 'bg-ev/10 text-ev';
                case 'battery': return 'bg-battery/10 text-battery';
                default: return 'bg-slate-100 text-slate-600';
            }
        }

        function updateStats(data) {
            document.getElementById('stat-total').innerText = data.length;
            document.getElementById('stat-japanese').innerText = data.filter(i => i.category === 'japanese').length;
            document.getElementById('stat-ev').innerText = data.filter(i => i.category === 'ev' || i.category === 'battery').length;
        }

        function sortTable(key) {
            if (currentSort.key === key) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.key = key;
                currentSort.asc = true;
            }

            const sorted = [...factoryData].sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                if (key === 'location') {
                    valA = `${a.state} ${a.city}`;
                    valB = `${b.state} ${b.city}`;
                }
                return currentSort.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
            });

            applyFilters(sorted);
        }

        function setupEventListeners() {
            // Tabs
            const tabMap = document.getElementById('tab-map');
            const tabTable = document.getElementById('tab-table');
            const viewMap = document.getElementById('view-map');
            const viewTable = document.getElementById('view-table');

            tabMap.addEventListener('click', () => {
                tabMap.classList.add('bg-white', 'shadow-sm', 'text-primary-700');
                tabMap.classList.remove('text-slate-600', 'hover:bg-white/50');
                tabTable.classList.remove('bg-white', 'shadow-sm', 'text-primary-700');
                tabTable.classList.add('text-slate-600', 'hover:bg-white/50');
                viewMap.classList.remove('hidden');
                viewTable.classList.add('hidden');
                setTimeout(() => map.invalidateSize(), 100);
            });

            tabTable.addEventListener('click', () => {
                tabTable.classList.add('bg-white', 'shadow-sm', 'text-primary-700');
                tabTable.classList.remove('text-slate-600', 'hover:bg-white/50');
                tabMap.classList.remove('bg-white', 'shadow-sm', 'text-primary-700');
                tabMap.classList.add('text-slate-600', 'hover:bg-white/50');
                viewTable.classList.remove('hidden');
                viewMap.classList.add('hidden');
            });

            // Filters
            const searchInput = document.getElementById('search-input');
            const filterCategory = document.getElementById('filter-category');
            const filterProcess = document.getElementById('filter-process');

            [searchInput, filterCategory, filterProcess].forEach(el => {
                el.addEventListener('input', () => applyFilters());
            });

            // Export
            document.getElementById('export-btn').addEventListener('click', exportToCSV);
        }

        function applyFilters(dataToFilter = null) {
            const search = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            const process = document.getElementById('filter-process').value;

            const filtered = (dataToFilter || factoryData).filter(item => {
                const matchSearch = item.name.toLowerCase().includes(search) || 
                                    item.city.toLowerCase().includes(search) || 
                                    item.state.toLowerCase().includes(search) ||
                                    item.product.toLowerCase().includes(search);
                const matchCategory = category === 'all' || item.category === category;
                const matchProcess = process === 'all' || item.process === process;
                return matchSearch && matchCategory && matchProcess;
            });

            renderMarkers(filtered);
            renderTable(filtered);
            // Don't update general stats, maybe? Or update to reflect filter?
            // document.getElementById('stat-total').innerText = filtered.length; 
        }

        function exportToCSV() {
            const headers = ["ID", "Name", "City", "State", "Product", "Capacity", "Area", "Process", "Category"];
            const rows = factoryData.map(item => [
                item.id, item.name, item.city, item.state, `"${item.product}"`, `"${item.capacity}"`, `"${item.area}"`, item.process, item.category
            ]);

            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "usa_auto_manufacturing_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Run On Load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
